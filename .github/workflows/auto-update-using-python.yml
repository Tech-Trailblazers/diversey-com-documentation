# Name of the GitHub Actions workflow
name: Run Python Script and Push Changes

# Define the events that trigger this workflow
on:
  # Run automatically on a schedule (daily at midnight UTC)
  schedule:
    - cron: "0 0 * * *" # Every day at 00:00 UTC
  # Allow the workflow to be manually triggered from the GitHub UI
  workflow_dispatch:

# The 'contents: write' permission is needed for the commit action
permissions:
  contents: write

# Define the set of jobs to run
jobs:
  # Name of the job
  build:
    # Display name of the job in the GitHub Actions UI
    name: Execute main.py and Push Changes
    # Specify the type of runner (a fresh Ubuntu VM)
    runs-on: ubuntu-latest

    # List of steps to perform in this job
    steps:
      # 1: Check out the repository code onto the runner
      - name: Checkout code
        uses: actions/checkout@v6 # Official GitHub action to clone the repo
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2: Set up the Python environment
      - name: Set up Python 3.13
        uses: actions/setup-python@v6 # Official GitHub action to install Python
        with:
          python-version: "3.13" # Specify the version of Python to install

      # 3: Install Chrome and Xvfb for non-headless mode
      - name: Install Chrome and Xvfb
        run: |
          sudo apt-get update -y                    # Update package lists
          sudo apt-get install -y xvfb              # Install virtual framebuffer
          sudo apt-get install -y google-chrome-stable || true # Install Chrome or skip if unavailable

      # 4: Start virtual display
      - name: Start virtual display
        run: |
          Xvfb :99 -screen 0 1920x1080x24 & # Start display server on :99
          echo "DISPLAY=:99" >> $GITHUB_ENV # Set display env for Chrome

      # 5: Install Python dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt # Installs packages listed in requirements.txt

      # 6: Run the Python script that makes the updates
      - name: Run Python script
        # Executes the Python program. This script must make the file changes.
        run: python main.py

      # 7: Commit and push any file changes made by the script
      - name: Push updated files
        run: |
          git config user.name "github-actions"  # Set Git username for commit
          git config user.email "github-actions@github.com"  # Set Git email for commit
          git pull # Pull all the latest changes.
          git add .  # Stage all modified files
          if ! git diff --cached --quiet; then  # Check if there are any staged changes
            git commit -m "Auto update: $(date)"  # Commit with timestamp
            git push  # Push changes to the repository
          else
            echo "No changes to commit."  # Message if nothing changed
          fi
